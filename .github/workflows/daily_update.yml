name: NBA Schedule & Odds Monitor

on:
  # 1. å…è¨±æ‰‹å‹•æŒ‰æŒ‰éˆ•æ¸¬è©¦ (ä¸è«–å¹¾é»æŒ‰ï¼Œéƒ½æœƒå¼·åˆ¶åŸ·è¡Œé æ¸¬)
  workflow_dispatch:
    inputs:
      force_predict:
        description: 'Force Run Prediction?'
        required: false
        default: 'true'

  # 2. å®šæ™‚æ’ç¨‹ (UTC æ™‚é–“)
  # å°ç£ 12:00 (UTC 04:00) é–‹å§‹ï¼Œåˆ° å°ç£ 21:30 (UTC 13:30) çµæŸ
  # æ¯ 30 åˆ†é˜ä¸€æ¬¡
  schedule:
    - cron: '*/30 4-13 * * *'

permissions:
  contents: write

jobs:
  daily-task:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ==================================================
      # ä»»å‹™ 1: æ›´æ–°è³½ç¨‹èˆ‡è³ ç‡ (ç„¡è«–å¹¾é»ï¼Œæ¯æ¬¡éƒ½è·‘)
      # ==================================================
      - name: 1. Fetch Schedule & Odds (Always Run)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "ğŸ€ [$(date)] Fetching Latest Schedule..."
          python scrape_schedule.py
          
          echo "ğŸ’° [$(date)] Fetching Latest Odds..."
          python scrape_odds.py

      # ==================================================
      # ä»»å‹™ 2: åŸ·è¡Œé æ¸¬ (åªåœ¨å°ç£ 22:00 æˆ–æ‰‹å‹•è§¸ç™¼æ™‚è·‘)
      # ==================================================
      - name: 2. Conditional Prediction (22:00 CST Only)
        run: |
          # å–å¾—ç•¶å‰ UTC å°æ™‚ (00-23)
          CURRENT_HOUR=$(date -u +%H)
          
          echo "ğŸ•’ Current UTC Hour: $CURRENT_HOUR (Taiwan: UTC+8)"
          
          # é‚è¼¯åˆ¤æ–·ï¼š
          # 1. å¦‚æœ UTC å°æ™‚æ˜¯ "14" (å³å°ç£ 22:00 - 22:59)
          # 2. æˆ–è€… é€™æ˜¯æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
          if [ "$CURRENT_HOUR" == "14" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸš€ It's 22:00 CST! Starting AI Prediction Pipeline..."
            
            # é€™è£¡ä¸è·‘çˆ¬èŸ²(scrape_new_stats)ï¼Œç›´æ¥è®€ä½ ä¸Šå‚³çš„ CSV
            echo "ğŸ§  Training Model..."
            python train_model.py
            
            echo "ğŸ”® Generating Picks..."
            python aggregate_picks.py
            
          else
            echo "ğŸ’¤ It's not 22:00 CST yet. Skipping Prediction."
            echo "âœ… Only Schedule & Odds were updated."
          fi

      # ==================================================
      # ä»»å‹™ 3: å­˜æª” (Commit)
      # ==================================================
      - name: Commit and Push Results
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # åŠ å…¥æ‰€æœ‰è®Šæ›´ (åŒ…å« data/ è³‡æ–™å¤¾)
          git add .
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´ï¼Œæœ‰æ‰ Commit
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ¤– Auto-update: Schedule/Odds (Prediction: ${{ github.event_name == 'workflow_dispatch' || env.CURRENT_HOUR == '14' }})"
            git push
          fi