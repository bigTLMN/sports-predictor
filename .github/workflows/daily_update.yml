name: Daily Sports Update

# 設定觸發時機
on:
  # 每天台灣時間晚上 10:00 (UTC 14:00)
  schedule:
    - cron: '0 14 * * *'
  
  # 手動觸發
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 1. 更新賽程與比分 (這步最重要，要先把昨天的比分抓回來)
      - name: Run Schedule Scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scrape_schedule.py

      # 2. 執行結算 (新增這步！根據剛剛更新的比分來對答案)
      - name: Grade Past Picks
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python grade_picks.py

      # 3. 抓取真實盤口 (準備明天的資料)
      - name: Run Odds Scraper
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scrape_odds.py

      # 4. 產生新的推薦 (最後一步)
      - name: Run Aggregation Engine
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python aggregate_picks.py