name: NBA Schedule & Odds Monitor

on:
  # 1. æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_predict:
        description: 'Force Run Prediction?'
        required: false
        default: 'true'

  # 2. å®šæ™‚æ’ç¨‹ (UTC 4:00 - 13:30ï¼Œå³å°ç£ 12:00 - 21:30)
  schedule:
    - cron: '*/30 4-13 * * *'

permissions:
  contents: write

jobs:
  daily-task:
    runs-on: ubuntu-latest
    
    # ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ­£é‡é»ï¼šæŠŠç’°å¢ƒè®Šæ•¸æ”¾åœ¨é€™è£¡ (Job Level) ğŸ”¥ğŸ”¥ğŸ”¥
    # é€™æ¨£åº•ä¸‹çš„æ¯ä¸€å€‹ step (åŒ…å«é æ¸¬) éƒ½æœƒè‡ªå‹•åƒåˆ°é€™äº›é‡‘é‘°ï¼Œä¸æœƒå†å ±éŒ¯äº†
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ==================================================
      # ä»»å‹™ 1: æ›´æ–°è³½ç¨‹èˆ‡è³ ç‡ (ç„¡è«–å¹¾é»ï¼Œæ¯æ¬¡éƒ½è·‘)
      # ==================================================
      - name: 1. Fetch Schedule & Odds (Always Run)
        run: |
          echo "ğŸ€ [$(date)] Fetching Latest Schedule..."
          python scrape_schedule.py
          
          echo "ğŸ’° [$(date)] Fetching Latest Odds..."
          python scrape_odds.py

      # ==================================================
      # ä»»å‹™ 2: åŸ·è¡Œé æ¸¬ (åªåœ¨å°ç£ 22:00 æˆ–æ‰‹å‹•è§¸ç™¼æ™‚è·‘)
      # ==================================================
      - name: 2. Conditional Prediction (22:00 CST Only)
        run: |
          # å–å¾—ç•¶å‰ UTC å°æ™‚
          CURRENT_HOUR=$(date -u +%H)
          
          echo "ğŸ•’ Current UTC Hour: $CURRENT_HOUR (Taiwan: UTC+8)"
          
          # åˆ¤æ–·é‚è¼¯ï¼šUTC 14é» (å°22é») æˆ– æ‰‹å‹•è§¸ç™¼
          if [ "$CURRENT_HOUR" == "14" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸš€ It's 22:00 CST! Starting AI Prediction Pipeline..."
            
            # é€™è£¡ä¸è·‘çˆ¬èŸ²(scrape_new_stats)ï¼Œç›´æ¥è®€ä½ ä¸Šå‚³çš„ CSV
            echo "ğŸ§  Training Model..."
            python train_model.py
            
            echo "ğŸ”® Generating Picks..."
            # é€™è£¡ä¹‹å‰å ±éŒ¯ï¼Œç¾åœ¨å› ç‚º env åœ¨æœ€ä¸Šé¢è¨­å®šå¥½äº†ï¼Œæ‰€ä»¥æœƒæˆåŠŸ
            python aggregate_picks.py
            
          else
            echo "ğŸ’¤ It's not 22:00 CST yet. Skipping Prediction."
            echo "âœ… Only Schedule & Odds were updated."
          fi

      # ==================================================
      # ä»»å‹™ 3: å­˜æª” (Commit)
      # ==================================================
      - name: Commit and Push Results
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ¤– Auto-update: Schedule/Odds (Prediction: ${{ github.event_name == 'workflow_dispatch' || env.CURRENT_HOUR == '14' }})"
            git push
          fi