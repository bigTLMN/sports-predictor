name: Daily NBA Prediction & Grading

on:
  schedule:
    # 1. æˆ°ç¸¾æ›´æ–°æ™‚æ®µï¼šå°ç£ 10:00 - 15:30 (UTC 02:00 - 07:30)
    #    æ¯å°æ™‚çš„ 0 åˆ†èˆ‡ 30 åˆ†åŸ·è¡Œä¸€æ¬¡
    - cron: '0,30 2-7 * * *'
    
    # 2. æ™šé–“é æ¸¬æ™‚æ®µï¼šå°ç£ 22:05 (UTC 14:05)
    #    é€™æ™‚å€™æ‰åŸ·è¡Œ AI é æ¸¬
    - cron: '5 14 * * *'

  # æ‰‹å‹•è§¸ç™¼æŒ‰éˆ•
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run NBA Logic
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        # é è¨­é—œé–‰ä¸Šå¸æ¨¡å¼ï¼Œç¢ºä¿ CI/CD ä¸æœƒæ”¹å¯«æ­·å²
        CHEAT_MODE: false
      run: |
        # -------------------------------------------
        # 1. åŸºç¤è³‡æ–™æ›´æ–° (æ›´æ–° Schedule, æ¯”åˆ†, è³ ç‡)
        # -------------------------------------------
        echo "ğŸ€ Fetching Schedule & Scores..."
        python scrape_schedule.py
        
        echo "ğŸ“Š Fetching Odds..."
        python scrape_odds.py
        
        # -------------------------------------------
        # 2. è‡ªå‹•é€²åŒ–å¾ªç’° (Auto-Training Loop)
        # -------------------------------------------
        # æŠ“å–æ˜¨æ—¥è©³ç´°æ•¸æ“š -> æ›´æ–° CSV -> é‡æ–°è¨“ç·´æ¨¡å‹
        
        echo "ğŸ“ˆ Updating Training Data..."
        python scrape_new_stats.py
        
        echo "ğŸ§  Retraining AI Model..."
        python train_model.py
        
        # -------------------------------------------
        # 3. åŸ·è¡Œé æ¸¬ (åƒ…åœ¨æ™šä¸Šæˆ–æ‰‹å‹•è§¸ç™¼æ™‚)
        # -------------------------------------------
        
        CURRENT_HOUR=$(date -u +%H)
        EVENT_NAME="${{ github.event_name }}"
        
        echo "Current UTC Hour: $CURRENT_HOUR"
        
        # UTC 14:00 = å°ç£ 22:00
        if [ "$CURRENT_HOUR" == "14" ] || [ "$EVENT_NAME" == "workflow_dispatch" ]; then
          echo "ğŸš€ Executing AI Prediction..."
          python aggregate_picks.py
        else
          echo "ğŸ›‘ Daytime update - Skipping new predictions."
        fi
        
        # -------------------------------------------
        # 4. è³½æœçµç®— (Grading)
        # -------------------------------------------
        echo "ğŸ“ Grading Picks..."
        python grade_picks.py