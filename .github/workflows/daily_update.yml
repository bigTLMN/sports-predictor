name: NBA Schedule & Odds Monitor

on:
  # 1. æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_predict:
        description: 'Force Run Prediction?'
        required: false
        default: 'true'

  # 2. å®šæ™‚æ’ç¨‹ (UTC 1:00 - 14:30ï¼Œå³å°ç£ 09:00 - 22:30)
  # ğŸ”¥ ä¿®æ”¹ï¼šå¾ UTC 4 æ”¹ç‚º UTC 1 (å°ç£æ—©ä¸Š 9 é»)
  schedule:
    - cron: '*/30 1-14 * * *'
  
  # 3. ä»£ç¢¼æ¨é€æ™‚è‡ªå‹•è§¸ç™¼
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  daily-task:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      # ğŸ”¥ å°‡ Kaggle å¯†é‘°è¨­ç‚ºå…¨åŸŸç’°å¢ƒè®Šæ•¸ï¼Œæ–¹ä¾¿ Python æŠ“å–
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ==================================================
      # ä»»å‹™ 1: æ›´æ–°è³½ç¨‹ã€è³ ç‡èˆ‡çµç®— (ç„¡è«–å¹¾é»ï¼Œæ¯æ¬¡éƒ½è·‘)
      # ==================================================
      - name: 1. Fetch Schedule, Odds & Grade Picks (Always Run)
        run: |
          echo "ğŸ€ [$(date)] Fetching Latest Schedule..."
          python scrape_schedule.py
          
          echo "ğŸ’° [$(date)] Fetching Latest Odds..."
          python scrape_odds.py

          echo "ğŸ“ [$(date)] Grading Finished Games..."
          python grade_picks.py

      # ==================================================
      # ä»»å‹™ 2: åŸ·è¡Œé æ¸¬ (åªåœ¨å°ç£ 22:00 æˆ–æ‰‹å‹•/Push è§¸ç™¼æ™‚è·‘)
      # ==================================================
      - name: 2. Conditional Prediction (22:00 CST or Manual/Push)
        run: |
          # å–å¾—ç•¶å‰ UTC å°æ™‚
          CURRENT_HOUR=$(date -u +%H)
          
          echo "ğŸ•’ Current UTC Hour: $CURRENT_HOUR (Taiwan: UTC+8)"
          
          # åˆ¤æ–·é‚è¼¯ï¼šUTC 14é» (å°22é») æˆ– æ‰‹å‹•è§¸ç™¼ æˆ– Pushè§¸ç™¼
          if [ "$CURRENT_HOUR" == "14" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸš€ It's 22:00 CST (or triggered manually/push)! Starting AI Prediction Pipeline..."
            
            # ğŸ”¥ ä¿®æ”¹ï¼šåœ¨è¨“ç·´å‰ï¼Œå…ˆå¾ Kaggle æ›´æ–°æ•¸æ“š
            echo "ğŸ“¥ Updating TeamStatistics.csv from Kaggle..."
            python fetch_kaggle_data.py

            echo "ğŸ§  Training Model..."
            python train_model.py
            
            echo "ğŸ”® Generating Picks..."
            python aggregate_picks.py
            
          else
            echo "ğŸ’¤ It's not 22:00 CST yet. Skipping Prediction & Data Update."
            echo "âœ… Only Schedule, Odds & Grading were updated."
          fi

      # ==================================================
      # ä»»å‹™ 3: å­˜æª” (Commit)
      # ==================================================
      - name: Commit and Push Results
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ¤– Auto-update: Schedule/Odds/Grading (Prediction: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || env.CURRENT_HOUR == '14' }})"
            git push
          fi