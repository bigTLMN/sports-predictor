name: NBA Schedule & Odds Monitor

on:
  # 1. æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_predict:
        description: 'Force Run Prediction?'
        required: false
        default: 'true'

  # 2. å®šæ™‚æ’ç¨‹ (UTC 4:00 - 14:30ï¼Œå³å°ç£ 12:00 - 22:30)
  schedule:
    - cron: '*/30 4-14 * * *'

permissions:
  contents: write

jobs:
  daily-task:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ==================================================
      # ä»»å‹™ 1: æ›´æ–°è³½ç¨‹ã€è³ ç‡èˆ‡ã€Œçµç®—ã€(ç„¡è«–å¹¾é»ï¼Œæ¯æ¬¡éƒ½è·‘)
      # ==================================================
      - name: 1. Fetch Schedule, Odds & Grade Picks (Always Run)
        run: |
          echo "ğŸ€ [$(date)] Fetching Latest Schedule..."
          python scrape_schedule.py
          
          echo "ğŸ’° [$(date)] Fetching Latest Odds..."
          python scrape_odds.py

          # ğŸ”¥ æ–°å¢ï¼šåŸ·è¡Œçµç®—ï¼Œè®“æ¯”è³½çµæŸå¾Œèƒ½è‡ªå‹•æ›´æ–°å‹æ•— ğŸ”¥
          echo "ğŸ“ [$(date)] Grading Finished Games..."
          python grade_picks.py

      # ==================================================
      # ä»»å‹™ 2: åŸ·è¡Œé æ¸¬ (åªåœ¨å°ç£ 22:00 æˆ–æ‰‹å‹•è§¸ç™¼æ™‚è·‘)
      # ==================================================
      - name: 2. Conditional Prediction (22:00 CST Only)
        run: |
          # å–å¾—ç•¶å‰ UTC å°æ™‚
          CURRENT_HOUR=$(date -u +%H)
          
          echo "ğŸ•’ Current UTC Hour: $CURRENT_HOUR (Taiwan: UTC+8)"
          
          # åˆ¤æ–·é‚è¼¯ï¼šUTC 14é» (å°22é») æˆ– æ‰‹å‹•è§¸ç™¼
          if [ "$CURRENT_HOUR" == "14" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ğŸš€ It's 22:00 CST! Starting AI Prediction Pipeline..."
            
            echo "ğŸ§  Training Model..."
            python train_model.py
            
            echo "ğŸ”® Generating Picks..."
            python aggregate_picks.py
            
          else
            echo "ğŸ’¤ It's not 22:00 CST yet. Skipping Prediction."
            echo "âœ… Only Schedule, Odds & Grading were updated."
          fi

      # ==================================================
      # ä»»å‹™ 3: å­˜æª” (Commit)
      # ==================================================
      - name: Commit and Push Results
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ğŸ¤– Auto-update: Schedule/Odds/Grading (Prediction: ${{ github.event_name == 'workflow_dispatch' || env.CURRENT_HOUR == '14' }})"
            git push
          fi